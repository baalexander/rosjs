(function(e,t){typeof define=="function"&&define.amd?define(["eventemitter2"],t):e.ROS=t(e.EventEmitter2)})(this,function(e){var t=function(t){function i(e){var t=JSON.stringify(e);r.readyState!==WebSocket.OPEN?n.once("connection",function(){r.send(t)}):r.send(t)}var n=this;n.idCounter=0;var r=new WebSocket(t);r.onopen=function(e){n.emit("connection",e)},r.onclose=function(e){n.emit("close",e)},r.onerror=function(e){n.emit("error",e)},r.onmessage=function(e){function t(e){e.op==="publish"?n.emit(e.topic,e.msg):e.op==="service_response"&&n.emit(e.id,e.values)}var r=JSON.parse(e.data);if(r.op==="png"){var i=new Image;i.onload=function(){var e=document.createElement("canvas"),n=e.getContext("2d");e.width=i.width,e.height=i.height,n.drawImage(i,0,0);var r=n.getImageData(0,0,i.width,i.height).data,s="";for(var o=0;o<r.length;o+=4)s+=String.fromCharCode(r[o],r[o+1],r[o+2]);t(JSON.parse(s))},i.src="data:image/png;base64,"+r.data}else t(r)},n.getTopics=function(e){var t=new n.Service({name:"/rosapi/topics",serviceType:"rosapi/Topics"}),r=new n.ServiceRequest;t.callService(r,function(t){e(t.topics)})},n.Message=function(e){var t=this;e&&Object.keys(e).forEach(function(n){t[n]=e[n]})},n.Topic=function(e){var t=this;e=e||{},t.node=e.node,t.name=e.name,t.messageType=e.messageType,t.isAdvertised=!1,t.compression=e.compression||"none",t.compression&&t.compression!=="png"&&t.compression!=="none"&&t.emit("warning",t.compression+" compression is not supported. No comression will be used."),t.subscribe=function(e){t.on("message",function(t){e(t)}),n.on(t.name,function(e){var r=new n.Message(e);t.emit("message",r)}),n.idCounter++;var r="subscribe:"+t.name+":"+n.idCounter,s={op:"subscribe",id:r,type:t.messageType,topic:t.name,compression:t.compression};i(s)},t.unsubscribe=function(){n.removeAllListeners([t.name]),n.idCounter++;var e="unsubscribe:"+t.name+":"+n.idCounter,r={op:"unsubscribe",id:e,topic:t.name};i(r)},t.advertise=function(){n.idCounter++;var e="advertise:"+t.name+":"+n.idCounter,r={op:"advertise",id:e,type:t.messageType,topic:t.name};i(r),t.isAdvertised=!0},t.unadvertise=function(){n.idCounter++;var e="unadvertise:"+t.name+":"+n.idCounter,r={op:"unadvertise",id:e,topic:t.name};i(r),t.isAdvertised=!1},t.publish=function(e){t.isAdvertised||t.advertise(),n.idCounter++;var r="publish:"+t.name+":"+n.idCounter,s={op:"publish",id:r,topic:t.name,msg:e};i(s)}},n.Topic.prototype.__proto__=e.prototype,n.getServices=function(e){var t=new n.Service({name:"/rosapi/services",serviceType:"rosapi/Services"}),r=new n.ServiceRequest;t.callService(r,function(t){e(t.services)})},n.ServiceRequest=function(e){var t=this;e&&Object.keys(e).forEach(function(n){t[n]=e[n]})},n.ServiceResponse=function(e){var t=this;e&&Object.keys(e).forEach(function(n){t[n]=e[n]})},n.Service=function(e){var t=this;e=e||{},t.name=e.name,t.serviceType=e.serviceType,t.callService=function(e,r){n.idCounter++,serviceCallId="call_service:"+t.name+":"+n.idCounter,n.once(serviceCallId,function(e){var t=new n.ServiceResponse(e);r(t)});var s=[];Object.keys(e).forEach(function(t){s.push(e[t])});var o={op:"call_service",id:serviceCallId,service:t.name,args:s};i(o)}},n.Service.prototype.__proto__=e.prototype,n.getParams=function(e){var t=new n.Service({name:"/rosapi/get_param_names",serviceType:"rosapi/GetParamNames"}),r=new n.ServiceRequest;t.callService(r,function(t){e(t.names)})},n.Param=function(e){var t=this;e=e||{},t.name=e.name,t.get=function(e){var r=new n.Service({name:"/rosapi/get_param",serviceType:"rosapi/GetParam"}),i=new n.ServiceRequest({name:t.name,value:JSON.stringify("")});r.callService(i,function(t){var n=JSON.parse(t.value);e(n)})},t.set=function(e){var r=new n.Service({name:"/rosapi/set_param",serviceType:"rosapi/SetParam"}),i=new n.ServiceRequest({name:t.name,value:JSON.stringify(e)});r.callService(i,function(){})}},n.Param.prototype.__proto__=e.prototype};return t.prototype.__proto__=e.prototype,t});